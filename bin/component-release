#!/usr/bin/env node

var Q = require('q');

var winSpawn = require('win-spawn');
function spawn(cmd, args, options) {
  var def = Q.defer();
  var proc = winSpawn(cmd, args, options);
  proc.on('exit', function (code) {
    if (code !== 0) def.reject(new Error(cmd + ' exited with code ' + code));
    else def.resolve(null);
  });
  return def.promise;
}

var version = process.argv[2];

if (/^\d+\.\d+\.\d+$/.test(version)) {
  var commands = [];
  commands.push(['git', ['commit','-a', '-m', '"Release ' + version + '"']]);
  commands.push(['git', ['tag', version, '-a', '-m', '"v' + version + '"']]);
  commands.push(['git', ['push']]);
  commands.push(['git', ['push','--tags']]);
  var prom = Q.resolve();
  commands.forEach(function (command) {
    prom = prom.then(function () {
      console.log('\n\nexec: ' + command[0] + ' ' + command[1].join(' ') + '\n\n');
      return spawn(command[0], command[1], {stdio: 'inherit'});
    });
  });
  prom
    .then(function () {
      console.log('complete');
    })
    .done();
} else if (version) {
  console.error(version + ' does not match the expression `/^\\d+\\.\\d+\\.\\d+$/`');
} else {
  console.error('You must provide a version number');
}